# 03.swoole_server函数列表
---

#Table of Contents
- [swoole_server::__construct](#swoole_server__construct)
- [swoole_server::set](#swoole_serverset)
- [swoole_server::on](#swoole_serveron)
- [swoole_server::addlistener](#swoole_serveraddlistener)
- [swoole_server::handler](#swoole_serverhandler)
- [swoole_server::start](#swoole_serverstart)
- [swoole_server::reload](#swoole_serverreload)
- [swoole_server::shutdown](#swoole_servershutdown)
- [swoole_server::addtimer](#swoole_serveraddtimer)
- [swoole_server::deltimer](#swoole_serverdeltimer)
- [swoole_server::after](#swoole_serverafter)
- [swoole_server::close](#swoole_serverclose)
- [swoole_server::send](#swoole_serversend)
- [swoole_server::connection_info](#swoole_serverconnection_info)
- [swoole_server::connection_list](#swoole_serverconnection_list)
- [swoole_server::stats](#swoole_serverstats)
- [swoole_server::task](#swoole_servertask)
- [swoole_server::taskwait](#swoole_servertaskwait)
- [swoole_server::finish](#swoole_serverfinish)
- [swoole_server::heartbeat](#swoole_serverheartbeat)
- [swoole_get_mysqli_sock](#swoole_get_mysqli_sock)
- [swoole_set_process_name](#swoole_set_process_name)
- [swoole_version](#swoole_version)
- [swoole_strerror](#swoole_strerror)
- [swoole_errno](#swoole_errno)
- [swoole_get_local_ip](#swoole_get_local_ip)

---

##**swoole_server::__construct**
**功能描述**：创建一个swoole_server资源对象<br>
**函数原型**：<br>
```php
// 类成员函数
public function swoole_server::__construct(string $host, int $port, int $mode = SWOOLE_PROCESS,
    int $sock_type = SWOOLE_SOCK_TCP);
// 公共函数
function swoole_server_create(string $host, int $port, int $mode = SWOOLE_PROCESS,
    int $sock_type = SWOOLE_SOCK_TCP);
```
**返回**：一个swoole_server对象<br>
**参数说明**：<br>

| 参数        | 说明   |
|  --------  |  -------- |
| string host | 监听的IP地址 |
| int port |   监听的端口号   |
| int mode |   运行模式   |
| int sock_type |   指定的socket类型   |

**说明**：
host、port、socket_type的详细说明见[swoole_server::addlistener](#swoole_serveraddlistener)。<br>
mode指定了swoole_server的运行模式，共有如下三种：<br>

| mode        | 类型   | 说明 |
|  --------  |  -------- | -------- |
| SWOOLE_BASE | Base模式 | 传统的异步非阻塞Server。在Reactor内直接回调PHP的函数。如果回调函数中有阻塞操作会导致Server退化为同步模式。worker_num参数对与BASE模式仍然有效，swoole会启动多个Reactor进程 |
| SWOOLE_THREAD | 线程模式（已废弃）| 多线程Worker模式，Reactor线程来处理网络事件轮询，读取数据。得到的请求交给Worker线程去处理。多线程模式比进程模式轻量一些，而且线程之间可以共享堆栈和资源。 访问共享内存时会有同步问题，需要使用Swoole提供的锁机制来保护数据。 |
| SWOOLE_PROCESS | 进程模式（默认） | Swoole提供了完善的进程管理、内存保护机制。 在业务逻辑非常复杂的情况下，也可以长期稳定运行，适合业务逻辑非常复杂的场景。 |

**样例**:<br>
```php
$serv = new swoole_server("127.0.0.1" , 8888 , SWOOLE_PROCESS , SWOOLE_SOCK_TCP);
```

##**swoole_server::set**
**功能描述**：设置swoole_server运行时的各项参数<br>
**函数原型**：<br>
```php
// 类成员函数
public function swoole_server::set(array $setting);
// 公共函数
function swoole_server_set(swoole_server $server, array $setting);
```
**返回**：无<br>
**参数说明**：<br>

| 参数        | 说明   |
|  --------  |  -------- |
| array setting | 配置选项数组，采用key-value形式 |

**说明**：<br>
该函数必须在[swoole_server::start](#swoole_serverstart)函数调用前调用。<br>
全部swoole_server的配置参数[点此查看](https://github.com/LinkedDestiny/swoole-doc/blob/master/doc/01.%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9.md)<br>
**样例**:<br>
```php
$serv->set(
    array(
        'worker_num' => 8,
        'max_request' => 10000,
        'max_conn' => 100000,
        'dispatch_mode' => 2,
        'debug_mode'=> 1，
        'daemonize' => false,
    )
);
```

##**swoole_server::on**
**功能描述**：绑定swoole_server的相关回调函数<br>
**函数原型**：<br>
```php
// 类成员函数
public function bool swoole_server->on(string $event, mixed $callback);
```
**返回**：设置成功返回true，否则返回false<br>
**参数说明**：<br>

| 参数        | 说明   |
|  --------  |  -------- |
| string event | 回调的名称（大小写不敏感） |
| mixed callback | 回调的PHP函数，可以是函数名的字符串，类静态方法，对象方法数组，匿名函数 |

**说明**：<br>
该函数必须在[swoole_server::start](#swoole_serverstart)函数调用前调用。<br>
此方法与[swoole_server::handler](#swoole_serverhandler)功能相同，作用是与swoole_client风格保持一致。<br>
[swoole_server::on](#swoole_serveron)中事件名称字符串不要加on。<br>
全部的回调函数列表[点此查看](https://github.com/LinkedDestiny/swoole-doc/blob/master/doc/02.%E4%BA%8B%E4%BB%B6%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0.md)<br>
**样例**:<br>
```php
$serv->on('connect', function ($serv, $fd){
    echo "Client:Connect.\n";
});
$serv->on('receive', array( $myclass, 'onReceive' ) ); // onReceive是myclass的成员函数
```

##**swoole_server::addlistener**
**功能描述**：给swoole_server增加一个监听的地址和端口<br>
**函数原型**：<br>
```php
// 类成员函数
public function swoole_server::addlistener(string $host, int $port, $type = SWOOLE_SOCK_TCP);
// 公共函数
function swoole_server_addlisten(swoole_server $serv, string $host, int $port, $type = SWOOLE_SOCK_TCP);
```
**返回**：无<br>
**参数说明**：<br>

| 参数        | 说明   |
|  --------  |  -------- |
| string host | 监听的IP地址 |
| int port |   监听的端口号   |
| int sock_type |   指定的socket类型   |

**说明**：
swoole支持如下socket类型:<br>

| sock_type        | 说明   |
|  --------  |  -------- |
| SWOOLE_TCP/SWOOLE_SOCK_TCP | TCP IPv4 Socket |
| SWOOLE_TCP6/SWOOLE_SOCK_TCP6 | TCP IPv6 Socket |
| SWOOLE_UDP/SWOOLE_SOCK_UDP | UDP IPv4 Socket |
| SWOOLE_UDP6/SWOOLE_SOCK_UDP6 | UDP IPv4 Socket |
| SWOOLE_UNIX_DGRAM | Unix UDP Socket |
| SWOOLE_UNIX_STREAM | Unix TCP Socket |

> Unix Socket仅在1.7.1+后可用，此模式下**host**参数必须填写可访问的文件路径，**port**参数忽略<br>
Unix Socket模式下，客户端**fd**将不再是数字，而是一个文件路径的字符串<br>
SWOOLE_TCP等是1.7.0+后提供的简写方式，与1.7.0前的SWOOLE_SOCK_TCP是等同的<br>

**样例**:<br>
```php
$serv->addlistener("127.0.0.1", 9502, SWOOLE_SOCK_TCP);
$serv->addlistener("192.168.1.100", 9503, SWOOLE_SOCK_TCP);
$serv->addlistener("0.0.0.0", 9504, SWOOLE_SOCK_UDP);
$serv->addlistener("/var/run/myserv.sock", 0, SWOOLE_UNIX_STREAM);

swoole_server_addlisten($serv, "127.0.0.1", 9502, SWOOLE_SOCK_TCP);
```

##**swoole_server::handler**
**功能描述**：设置Server的事件回调函数<br>
**函数原型**：<br>
```php
// 类成员函数
public function swoole_server::handler(string $event_name, mixed $event_callback_function);
// 公共函数
function swoole_server_handler(swoole_server $serv, string $event_name, mixed $event_callback_function);
```
**返回**：设置成功返回true，否则返回false<br>
**参数说明**：<br>

| 参数        | 说明   |
|  --------  |  -------- |
| string event_name | 回调的名称（大小写不敏感） |
| mixed event_callback_function | 回调的PHP函数，可以是函数名的字符串，类静态方法，对象方法数组，匿名函数 |

**说明**：
该函数必须在[swoole_server::start](#swoole_server::start)函数调用前调用。<br>
事件名称字符串要加on。<br>
全部的回调函数列表[点此查看](https://github.com/LinkedDestiny/swoole-doc/blob/master/doc/02.%E4%BA%8B%E4%BB%B6%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0.md)<br>
> onConnect/onClose/onReceive这3个回调函数必须设置。其他事件回调函数可选<br>
如果设定了timer定时器，onTimer事件回调函数也必须设置<br>
如果启用了task_worker，onTask/onFinish事件回调函数必须设置<br>

**样例**:
```php
$serv->handler('onStart', 'my_onStart');
$serv->handler('onStart', array($this, 'my_onStart'));
$serv->handler('onStart', 'myClass::onStart');
```

##**swoole_server::start**
**功能描述**：启动server，开始监听所有TCP/UDP端口<br>
**函数原型**：<br>
```php
// 类成员函数
public function swoole_server::start()
```
**返回**：启动成功返回true，否则返回false<br>
**参数说明**：无<br>
**说明**：<br>
启动成功后会创建worker_num+2个进程：Master进程+Manager进程+worker_num 个 Worker进程。<br>
另外。启用task_worker会增加task_worker_num个Worker进程<br>
三种进程的说明如下：

| 进程类型        | 说明   |
|  --------  |  -------- |
| Master进程 | 主进程内有多个Reactor线程，基于epoll/kqueue进行网络事件轮询。收到数据后转发到Worker进程去处理 |
| Manager进程 | 对所有Worker进程进行管理，Worker进程生命周期结束或者发生异常时自动回收，并创建新的Worker进程 |
| Worker进程 | 对收到的数据进行处理，包括协议解析和响应请求 |

**样例**:
```php
$serv->start();
```

##**swoole_server::reload**
**功能描述**：重启所有worker进程。<br>
**函数原型**：<br>
```php
// 类成员函数
public function swoole_server::reload()
```
**返回**：调用成功返回true，否则返回false<br>
**参数说明**：无<br>
**说明**：<br>
调用后会向Manager发送一个SIGUSR1信号，平滑重启全部的Worker进程（所谓平滑重启，是指重启动作会在Worker处理完正在执行的任务后发生，并不会中断正在运行的任务。）<br>

小技巧：在[onWorkerStart](https://github.com/LinkedDestiny/swoole-doc/blob/master/doc/02.%E4%BA%8B%E4%BB%B6%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0.md#3onworkerstart)回调中require相应的php文件，当这些文件被修改后，只需要通过SIGUSR1信号即可实现服务器热更新。<br>

1.7.7版本增加了仅重启task_worker的功能。只需向服务器发送SIGUSR2即可<br>
**样例**:
```php
$serv->reload();
```

##**swoole_server::shutdown**
**功能描述**：关闭服务器。<br>
**函数原型**：<br>
```php
// 类成员函数
public function swoole_server::shutdown()
```
**返回**：调用成功返回true，否则返回false<br>
**参数说明**：无<br>
**说明**：<br>
此函数可以用在worker进程内，平滑关闭全部的Worker进程。<br>
也可向Master进程发送SIGTERM信号关闭服务器。<br>
**样例**:
```php
$serv->shutdown();
```

##**swoole_server::addtimer**
**功能描述**：设置一个固定间隔的定时器<br>
**函数原型**：<br>
```php
// 类成员函数
public function swoole_server::addtimer(int $interval);
// 公共函数
function swoole_server_addtimer(swoole_server $serv, int $interval);
```
**返回**：设置成功返回true，否则返回false<br>
**参数说明**：<br>

| 参数        | 说明   |
|  --------  |  -------- |
| int interval | 定时器的时间间隔，单位为毫秒ms |

**说明**：<br>
swoole定时器的最小颗粒是1毫秒，支持多个不同间隔的定时器。<br>
注意不能存在2个相同间隔时间的定时器。<br>
使用多个定时器时，其他定时器必须为最小定时器时间间隔的整数倍。<br>

该函数只能在onWorkerStart/onConnect/onReceive/onClose回调函数中调用。<br>
增加定时器后需要为Server设置[onTimer](https://github.com/LinkedDestiny/swoole-doc/blob/master/doc/02.%E4%BA%8B%E4%BB%B6%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0.md#8ontimer)回调函数，否则Server将无法启动。<br>

**样例**:
```php
$serv->addtimer(1000);              //1s
swoole_server_addtimer($serv,20);   //20ms
```

##**swoole_server::deltimer**
**功能描述**：删除指定的定时器。<br>
**函数原型**：<br>
```php
// 类成员函数
public function swoole_server::deltimer(int $interval);
```

**返回**：无<br>
**参数说明**：<br>

| 参数        | 说明   |
|  --------  |  -------- |
| int interval | 定时器的时间间隔，单位为毫秒ms |

**说明**：<br>
删除间隔为interval的定时器

**样例**:
```php
$serv->deltimer(1000);
```

##**swoole_server::after**
**功能描述**：在指定的时间后执行函数<br>
**函数原型**：<br>
```php
// 类成员函数
public function swoole_server::after(int $after_time_ms, mixed $callback_function);
// 公共函数
function swoole_timer_after(swoole_server $serv, int $after_time_ms， mixed $callback_function);
```
**返回**：无<br>
**参数说明**：<br>

| 参数        | 说明   |
|  --------  |  -------- |
| int after_time_ms | 指定时间，单位为毫秒ms |
| mixed callback_function | 指定的回调函数 |

**说明**：<br>
创建一个一次性定时器，在指定的after_time_ms时间后调用callback_funciton回调函数，执行完成后就会销毁。<br>
callback_function函数不接受任何参数<br>
需要swoole-1.7.7以上版本。<br>

**样例**:
```php
$serv->after(1000, function(){
    echo "Do something\n";
});
```








